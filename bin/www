#!/usr/bin/env node

/**
 * Module dependencies.
 */

var app = require('../app');
var debug = require('debug')('hospital-system:server');
var http = require('http');

/**
 * Get port from environment and store in Express.
 */

var port = normalizePort(process.env.PORT || '3000');
app.set('port', port);

/**
 * Create HTTP server.
 */

var server = http.createServer(app);

// create all the channel
var io = require('socket.io')(server);
var patientChannel = io.of('/patient');
var doctorChannel = io.of('/doctor');
var staffChanel = io.of('staff');



var servicesDoctorChanel= io.of('/services_doctor');


//io.listen(server);
console.log("socket is running");
io.on('connection', function (socket) {

    io.to(socket.id).emit('Welcome', {message: 'Welcome to server'});
    console.log("Client " + socket.id + " connected");

    socket.on('disconnect', function () {
        console.log("Client " + this.id + " disconnected");
    });

    socket.on('sendMessage', function (data) {
        console.log(data.content);
        io.emit('newMessage', data);
    });

});


//handle patient
patientChannel.on('connection', function (socket) {
    console.log("www 50 client " + socket.id + " connected");
    /*this event will send all the data to build UI for patient
     * include list doctors, Session (activity), profile
     *
     * */
    socket.on('get_data_for_patient', function (data) {
        var id = socket.id;
        console.log("www 61" + JSON.stringify(data));
        require('../models/users').authenticateToken(data.token).then(function (user) {
            //save socket id to database to send noti
            //var newuser=
            user.current_socket_id = id;
            user.save().then(function (user) {
                console.log("www 66, saved socket_id" + JSON.stringify(user));
            }, function (err) {
                console.log("www 68" + JSON.stringify(err));
            });

            // get List Doctors
            require('../models/doctors').getAllDoctorDetails().then(function (_data) {
                var back_data = {};
                back_data.listDoctors = _data;

                // get Session and doctor detail foreach session
                require('../models/sessions').getSessionsByUsername(user.username)
                    .then(function (sessions) {
                        back_data.sessions = sessions;

                        var allPromise = [];


                        for (idx in sessions){
                            console.log(sessions[idx].username_doctor +" www 88");
                            allPromise.push(
                                require('../models/doctors').getDoctorDetailByUserName(sessions[idx].username_doctor));

                        }
                        Promise.all(allPromise).then(function (doctors) {
                            //console.log(doctors[0].fullName);
                            for (k in sessions) {
                                sessions[k].username_doctor = doctors[k].fullname;
                            }
                            //TODO: get profile

                            // console.log(user.username);
                            require('../models/patients').getPaitentByUserName(user.username).then(function (patients) {
                                var patient = patients[0];

                                back_data.profile = patient;
                                console.log("www90" + JSON.stringify(patient));

                                //TODO : get notification
                                require('../models/notifications')
                                    .getNotificationByUsername(user.username)
                                    .then(function (notis) {

                                        console.log("www 99 "+ JSON.stringify(notis));
                                        back_data.notifications=notis;

                                        //let allPromise=[];
                                        //console.log(back_data.notifications);
                                        patientChannel.to(id).emit('data_build_UI', back_data);
                                    }, function (err) {
                                        console.log("www 119"+ JSON.stringify(err));

                                    });

                            }, function (err) {
                                console.log("www 112: " + JSON.stringify(err));
                            });
                        }, function (err) {
                            console.log(" www 114" + JSON.stringify(err));
                        });


                    }, function(err){
                        console.log("www 118"+ JSON.stringify(err));
                    });
                //patientChannel.to(id).emit('data_build_UI', back_data);
            }, function(err){
                console.log('www 122 '+ JSON.stringify(err));

            });

        }, function (err) {

        });

    });

    socket.on('send_request', function (data) {
        console.log("www 147 :" + JSON.stringify(data));

        // TODO: create a new notify for staff and new waiting_request
        var Waiting_Request = require('../models/waiting_requests');
        require('../models/users').authenticateToken(data.info.token).then(function (_patient) {

            console.log("www 153");
            var new_waiting_request = new Waiting_Request({
                username: _patient.username,
                description: data.description
            });

            new_waiting_request.save().then(function (waiting_request) {
                console.log(waiting_request);
                var Notify = require('../models/notifications');

                console.log("www 163");
                var new_totify = new Notify({
                    username: "longvuong",
                    username_doctor: "",
                    content: "Có một request khám bệnh mới",
                    date : new Date().toDateString(),
                    time: ""
                });
                new_totify.save().then(function (notify) {
                    console.log(notify);

                    // emit notify to all staff (trong nay dang den 1 staff)
                    require('../models/users').getSocketIdByUsername("longvuong")
                        .then(function (socketid) {

                            // console.log("www 177: " + patient_socketid);
                            var data = {
                                msg: "Có một request khám bệnh mới"
                            }
                            staffChanel.emit('noti_new_request', data)
                                socket.to(socketid).emit('noti_new_request', data);
                        }, function (err) {
                            console.log(err);
                        });
                }, function (err) {
                    console.log("www 170: " + JSON.stringify(err));
                })
            }, function (err) {
                console.log("www 160: " + JSON.stringify(err));
            })
        });
    });

    socket.on('disconnect', function () {
        console.log("www 142" + "patient " + socket.id + "disconnect");
        //delete socket id in DB
        require('../models/users')
            .getUserBySocketId(socket.id).then(function (user) {
            user.current_socket_id="";
            user.save().then(function (user) {
                console.log("www 148 đã xóa socketid patient");
            }, function (err) {
                console.log("www 150"+ JSON.stringify(err));
            });
        }, function (err) {
            console.log("www 148", JSON.stringify(err));
        });

    });
});

// handle doctor

doctorChannel.on('connection', function (socket) {

    console.log('www 139 ' + socket.id + " connected");
    socket.on('get_data_for_doctor', function (data) {


        console.log("www 141: " + JSON.stringify(data));
        var id = socket.id;



        // authenticate user
        require('../models/users').authenticateToken(data.token).then(function (doctor) {

            //save socket id to push notification
            doctor.current_socket_id = id;
            doctor.save().then(function (doctor) {
                console.log("www 234" + JSON.stringify(doctor));
            }, function (err) {
                console.log("www 263" + JSON.stringify(err));
            });

            // get profile
            require('../models/doctors').getDoctorDetailByUserName(doctor.username).then(function (_doctor) {

                var response_data = {};

                response_data.profile = _doctor;

                // get list waiting request of doctor
                require('../models/waiting_requests').getWaitingRequestByDoctor(_doctor.username)
                    .then(function (waiting_requests) {

                        response_data.listRequests = waiting_requests;

                        // get list patient by doctor who serve this patient
                        require('../models/sessions').getActiveSessionByDoctor(_doctor.username).then(function (sessions) {

                            response_data.listPatients = sessions;

                            console.log("www 198: " + JSON.stringify(response_data));


                            // send back data to doctor
                            doctorChannel.to(id).emit('data_build_UI', response_data);

                            },function (err) {
                                console.log("www 203 : " + JSON.stringify(err));
                            });

                    }, function (err) {
                        console.log(err);
                    })
            }, function (err) {
                console.log(err);
            });
        }, function (err) {
            console.log(err);
        });
    });

    socket.on('createActivity', function (data) {
        //create new act and update db, create noti, and send noti if can
        

       console.log(data);
    });
    socket.on('disconnect', function () {
        console.log("www 142" + "doctor " + socket.id + "disconnect");
        //delete socket id in DB
        require('../models/users')
            .getUserBySocketId(socket.id).then(function (user) {
            user.current_socket_id="";
            user.save().then(function (user) {
                console.log("www 148 đã xóa socketid patient");
            }, function (err) {
                console.log("www 150"+ JSON.stringify(err));
            });
        }, function (err) {
            console.log("www 148", JSON.stringify(err));
        });
    });

    socket.on('setup_appointment', function (data) {

        //write logic
        var id =socket.id;
        require('../models/users').authenticateToken(data.global_info.token)
            .then(function (doctor) {
                // create new Session
                var Session =require('../models/sessions');
                var newSession= new Session({
                    description: data.description,
                    username: data.patient_username,
                    username_doctor: doctor.username,

                    status: "active",
                    activities: [],
                    result: "Chưa có kết luận",
                    begin_date: data.date_time,
                });

                newSession.save().then(function (session) {
                    // send for doctor and patient

                    // get socket id of patient
                    var patient_socketID;
                    require('../models/users')
                        .getSocketIdByUsername(data.patient_username)
                        .then(function (socketid) {

                            var today = new Date();
                            var dd = today.getDate();
                            var mm = today.getMonth()+1;
                            var yyyy = today.getFullYear();

                            if(dd<10) {
                                dd='0'+dd
                            }

                            if(mm<10) {
                                mm='0'+mm
                            }

                            var stringDate= mm+'/'+dd+'/'+yyyy;
                            var stringhour= today.getHours()+":"+today.getMinutes();
                            // create notifi send back
                            var Noti=require('../models/notifications');
                            var newNoti=new Noti({
                                username: data.patient_username,
                                username_doctor: doctor.username,
                                content: "Có lịch hẹn khám bệnh mới",
                                date: stringDate,
                                time: stringhour,
                            });

                            newNoti.save()
                                .then(function (noti) {
                                    var send_back={
                                        notification: noti,
                                        msg: "Bạn có lịch hẹn khám bệnh mới"
                                    };
                                    patientChannel.to(socketid).emit("send_noti", send_back);
                                }, function (err) {
                                   console.log("www 287"+ JSON.stringify(err));
                                });

                        }, function (err) {

                        });

                    doctorChannel.to(id).emit('setup_appointment_ss',{
                        msg: "Success"
                    });

                }, function (err) {

                });
            }, function (err) {

            });

        console.log("www 226"+ JSON.stringify(data));
    })

});

// handle staff channel

staffChanel.on('connection', function (socket) {
    console.log("www 169 connected: " +socket);
    socket.on('get_data_for_staff', function (data) {
        console.log("www 171 " + socket.id);
        var id = socket.id;

        // authenticate user
        require('../models/users').authenticateToken(data.token).then(function (staff) {

            //save socket id to push notification
            staff.current_socket_id = id;
            staff.save().then(function (staff) {
                console.log("www 299" + JSON.stringify(staff));
            }, function (err) {
                console.log("www 301" + JSON.stringify(err));
            });

            var response_data = {};

            // get profile of staff
            require('../models/staffs').getStaffDetailByUserName(staff.username).then(function (_staff) {

                response_data.profile = _staff;

                // get all waiting requests
                require('../models/waiting_requests').getAllWaitingRequest().then(function (waiting_requests) {

                    response_data.listRequests = waiting_requests;

                    console.log("www 322: " + JSON.stringify(response_data));
                    // send back data to client
                    staffChanel.to(id).emit('data_build_UI', response_data);

                }, function (err) {
                    console.log("www 312 : " + JSON.stringify(err));
                });
            }, function (err) {
                console.log("www 310 : " + JSON.stringify(err));
            });
        }, function (err) {
            console.log("www 297: " + JSON.stringify(err));
        });
    });
});


/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
    var port = parseInt(val, 10);

    if (isNaN(port)) {
        // named pipe
        return val;
    }

    if (port >= 0) {
        // port number
        return port;
    }

    return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
    if (error.syscall !== 'listen') {
        throw error;
    }

    var bind = typeof port === 'string'
        ? 'Pipe ' + port
        : 'Port ' + port;

    // handle specific listen errors with friendly messages
    switch (error.code) {
        case 'EACCES':
            console.error(bind + ' requires elevated privileges');
            process.exit(1);
            break;
        case 'EADDRINUSE':
            console.error(bind + ' is already in use');
            process.exit(1);
            break;
        default:
            throw error;
    }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
    var addr = server.address();
    var bind = typeof addr === 'string'
        ? 'pipe ' + addr
        : 'port ' + addr.port;
    debug('Listening on ' + bind);
}
