#!/usr/bin/env node

/**
 * Module dependencies.
 */

var app = require('../app');
var debug = require('debug')('hospital-system:server');
var http = require('http');

/**
 * Get port from environment and store in Express.
 */

var port = normalizePort(process.env.PORT || '3000');
app.set('port', port);

/**
 * Create HTTP server.
 */

var server = http.createServer(app);

// create all the channel
var io = require('socket.io')(server);
var patientChannel = io.of('/patient');
var doctorChannel = io.of('/doctor');
var staffChanel = io.of('staff');



var servicesDoctorChanel= io.of('/services_doctor');


//io.listen(server);
console.log("socket is running");
io.on('connection', function (socket) {

    io.to(socket.id).emit('Welcome', {message: 'Welcome to server'});
    console.log("Client " + socket.id + " connected");

    socket.on('disconnect', function () {
        console.log("Client " + this.id + " disconnected");
    });

    socket.on('sendMessage', function (data) {
        console.log(data.content);
        io.emit('newMessage', data);
    });

});


//handle patient
patientChannel.on('connection', function (socket) {
    console.log("www 50 client " + socket.id + " connected");
    /*this event will send all the data to build UI for patient
     * include list doctors, Session (activity), profile
     *
     * */
    socket.on('get_data_for_patient', function (data) {
        var id = socket.id;
        console.log("www 61" + JSON.stringify(data));
        require('../models/users').authenticateToken(data.token).then(function (user) {
            //save socket id to database to send noti
            //var newuser=
            user.current_socket_id = id;
            user.save().then(function (user) {
                console.log("www 66, saved socket_id" + JSON.stringify(user));
            }, function (err) {
                console.log("www 68" + JSON.stringify(err));
            });

            // get List Doctors
            require('../models/doctors').getAllDoctorDetails().then(function (_data) {
                var back_data = {};
                back_data.listDoctors = _data;

                // get Session and doctor detail foreach session
                require('../models/sessions').getSessionsByUsername(user.username)
                    .then(function (sessions) {
                        back_data.sessions = sessions;

                        var allPromise = [];


                        for (idx in sessions){
                            console.log(sessions[idx].username_doctor +" www 88");
                            allPromise.push(
                                require('../models/doctors').getDoctorDetailByUserName(sessions[idx].username_doctor));

                        }
                        Promise.all(allPromise).then(function (doctors) {
                            //console.log(doctors[0].fullName);
                            for (k in sessions) {
                                sessions[k].username_doctor = doctors[k].fullname;
                            }
                            //TODO: get profile

                            // console.log(user.username);
                            require('../models/patients').getPaitentByUserName(user.username).then(function (patients) {
                                var patient = patients[0];

                                back_data.profile = patient;
                                console.log("www90" + JSON.stringify(patient));

                                //TODO : get notification
                                require('../models/notifications')
                                    .getNotificationByUsername(user.username)
                                    .then(function (notis) {

                                        console.log("www 99 "+ JSON.stringify(notis));
                                        back_data.notifications=notis;
                                        
                                        //let allPromise=[];
                                        //console.log(back_data.notifications);
                                        patientChannel.to(id).emit('data_build_UI', back_data);
                                    }, function (err) {
                                        console.log("www 119"+ JSON.stringify(err));

                                    });

                            }, function (err) {
                                console.log("www 112: " + JSON.stringify(err));
                            });
                        }, function (err) {
                            console.log(" www 114" + JSON.stringify(err));
                        });


                    }, function(err){
                        console.log("www 118"+ JSON.stringify(err));
                    });
                //patientChannel.to(id).emit('data_build_UI', back_data);
            }, function(err){
                console.log('www 122 '+ JSON.stringify(err));

            });

        }, function (err) {

        });

    });
    socket.on('disconnect', function () {
        console.log("www 142" + "patient " + socket.id + "disconnect");
        //delete socket id in DB
        require('../models/users')
            .getUserBySocketId(socket.id).then(function (user) {
            user.current_socket_id="";
            user.save().then(function (user) {
                console.log("www 148 đã xóa socketid patient");
            }, function (err) {
                console.log("www 150"+ JSON.stringify(err));
            });
        }, function (err) {
            console.log("www 148", JSON.stringify(err));
        });

    });
});

// handle doctor

doctorChannel.on('connection', function (socket) {

    console.log('www 139 ' + socket.id + " connected");
    socket.on('get_data_for_doctor', function (data) {


        console.log("www 141: " + JSON.stringify(data));
        var id = socket.id;



        // authenticate user
        require('../models/users').authenticateToken(data.token).then(function (doctor) {

            //save socket id to push notification
            doctor.current_socket_id = id;
            doctor.save().then(function (doctor) {
                console.log("www 161" + JSON.stringify(doctor));
            }, function (err) {
                console.log("www 163" + JSON.stringify(err));
            });

            require('../models/doctors').getDoctorDetailByUserName(doctor.username).then(function (_doctor) {

                var response_data = {};

                response_data.profile = _doctor;

                require('../models/waiting_requests').getWaitingRequestByDoctor(_doctor.username)
                    .then(function (waiting_requests) {

                        response_data.listRequests = waiting_requests;

                        doctorChannel.to(id).emit('data_build_UI', response_data);

                    }, function (err) {
                        console.log(err);
                    })
            }, function (err) {
                console.log(err);
            });
        }, function (err) {
            console.log(err);
        });
    });
    socket.on('disconnect', function () {
        console.log("www 142" + "doctor " + socket.id + "disconnect");
        //delete socket id in DB
        require('../models/users')
            .getUserBySocketId(socket.id).then(function (user) {
            user.current_socket_id="";
            user.save().then(function (user) {
                console.log("www 148 đã xóa socketid patient");
            }, function (err) {
                console.log("www 150"+ JSON.stringify(err));
            });
        }, function (err) {
            console.log("www 148", JSON.stringify(err));
        });
    });

});

// handle staff channel

staffChanel.on('connection', function (socket) {
    console.log("www 169 connected: " +socket);
    socket.on('get_data_for_staff', function (data) {
        console.log("www 171 " + socket.id);
        var id = socket.id;
        var back_data = {};
        staffChanel.to(id).emit('data_build_UI', back_data);
    });
});


/**
 * Listen on provided port, on all network interfaces.
 */

server.listen(port);
server.on('error', onError);
server.on('listening', onListening);

/**
 * Normalize a port into a number, string, or false.
 */

function normalizePort(val) {
    var port = parseInt(val, 10);

    if (isNaN(port)) {
        // named pipe
        return val;
    }

    if (port >= 0) {
        // port number
        return port;
    }

    return false;
}

/**
 * Event listener for HTTP server "error" event.
 */

function onError(error) {
    if (error.syscall !== 'listen') {
        throw error;
    }

    var bind = typeof port === 'string'
        ? 'Pipe ' + port
        : 'Port ' + port;

    // handle specific listen errors with friendly messages
    switch (error.code) {
        case 'EACCES':
            console.error(bind + ' requires elevated privileges');
            process.exit(1);
            break;
        case 'EADDRINUSE':
            console.error(bind + ' is already in use');
            process.exit(1);
            break;
        default:
            throw error;
    }
}

/**
 * Event listener for HTTP server "listening" event.
 */

function onListening() {
    var addr = server.address();
    var bind = typeof addr === 'string'
        ? 'pipe ' + addr
        : 'port ' + addr.port;
    debug('Listening on ' + bind);
}
